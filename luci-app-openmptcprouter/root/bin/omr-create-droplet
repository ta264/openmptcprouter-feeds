#!/bin/bash

set -e

# create droplet
DROPLET=$(curl -s -X POST \
     -H "Content-Type: application/json" \
     -H "Authorization: Bearer $DIGITALOCEAN_TOKEN" \
     -d '{"name":"omr-59","region":"lon1","size":"s-1vcpu-1gb","image":115613140,"ssh_keys":[36044102, 28855492],"backups":false,"ipv6":false,"user_data":null,"private_networking":null,"volumes": null,"tags":[]}' \
     "https://api.digitalocean.com/v2/droplets")
ID=$(echo $DROPLET | jq '.droplet.id')

echo "Created droplet: $ID"

IP=""
while [ -z "$IP" ]
do
    IP=$(curl -s -X GET \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer $DIGITALOCEAN_TOKEN" \
              "https://api.digitalocean.com/v2/droplets/$ID" | \
             jq -r '.droplet.networks.v4[] | select(.type == "public").ip_address')
    sleep 1s
done

echo "Droplet IP: $IP"
